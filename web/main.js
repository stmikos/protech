const API_BASE='https://protech-zf2a.onrender.com';
const areaEl=document.getElementById('area');const heightEl=document.getElementById('height');const workTypeEl=document.getElementById('work_type');const complexityEl=document.getElementById('complexity');const rateEl=document.getElementById('rate');const priceEl=document.getElementById('price');const daysEl=document.getElementById('days');const lastDateEl=document.getElementById('last_date');const cycleYearsEl=document.getElementById('cycle_years');const nextDateEl=document.getElementById('next_date');
function estimate(){const base={fire:550,paint:350,combo:820};const area=Math.max(0,Number(areaEl.value||0));const h=Math.max(0,Number(heightEl.value||0));const kH=h>8?1.15:(h>4?1.08:1);const kC={low:0.95,mid:1.0,high:1.12}[complexityEl.value]||1;const rate=(base[workTypeEl.value]||500)*kH*kC;const price=Math.round(rate*area);const days=Math.max(3,Math.ceil(area/120)+(workTypeEl.value==='combo'?2:0));rateEl.textContent=Math.round(rate).toLocaleString('ru-RU');priceEl.textContent=price.toLocaleString('ru-RU')+' ₽';daysEl.textContent=days+' дн.';}['input','change'].forEach(ev=>{areaEl.addEventListener(ev,estimate);heightEl.addEventListener(ev,estimate);workTypeEl.addEventListener(ev,estimate);complexityEl.addEventListener(ev,estimate);});estimate();function updateNextDate(){const v=lastDateEl.value;const years=Number(cycleYearsEl.value||0);if(!v||!years)return;const d=new Date(v);d.setFullYear(d.getFullYear()+years);nextDateEl.valueAsDate=d;}lastDateEl.addEventListener('change',updateNextDate);cycleYearsEl.addEventListener('change',updateNextDate);
document.getElementById('sendBtn').addEventListener('click',async()=>{const status=document.getElementById('status');status.textContent='Отправляем...';const payload={name:document.getElementById('name').value.trim(),phone:document.getElementById('phone').value.trim(),city:document.getElementById('city').value.trim(),object_address:document.getElementById('city').value.trim(),area_m2:Number(areaEl.value||0),height_m:Number(heightEl.value||0),work_type:workTypeEl.value,complexity:complexityEl.value,budget_est:Number(priceEl.textContent.replace(/[^0-9]/g,'')),last_service_date:lastDateEl.value||null,next_service_date:nextDateEl.value||null,comment:document.getElementById('comment').value.trim(),utm_source:'webapp',utm_campaign:'mvp'};if(!payload.name||!payload.phone){status.textContent='Заполните имя и телефон';return;}try{const res=await fetch(API_BASE+'/lead',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const data=await res.json();if(res.ok){status.textContent='Успех! Сделка создана #'+data.deal_id;}else{status.textContent='Ошибка: '+(data.detail||'см. логи');}}catch(e){status.textContent='Сеть недоступна: '+e.message;}});
